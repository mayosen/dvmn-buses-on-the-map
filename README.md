# Автобусы на карте Москвы
Веб-приложение, которое в реальном времени показывает передвижение автобусов на карте Москвы.

<img src="screenshots/buses.gif">

## Цель проекта
Код написан в учебных целях — это урок в курсе Асинхронный Python
на сайте [Devman](https://dvmn.org/modules/async-python/).  
Приложение состоит из двух частей, фронтенда и бэкенда. Используется Python 3.10.

## Как запустить
```bash
$ git clone https://github.com/mayosen/dvmn-buses-on-the-map.git -b master
$ python -m venv venv
$ source venv/bin/activate
$ pip install -r requirements.txt
```

Дальнейшие инструкции в секции частей.

## Фронтенд
### Настройки
Внизу справа на странице можно включить отладочный режим логирования и указать нестандартный адрес веб-сокета.

<img src="screenshots/settings.png">

Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.

Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.

### Формат данных
Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:

```json
{
  "msgType": "Buses",
  "buses": [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"}
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:

```json
{
  "msgType": "NewBounds",
  "data": {
    "east_lng": 37.65563964843751,
    "north_lat": 55.77367652953477,
    "south_lat": 55.72628839374007,
    "west_lng": 37.54440307617188
  }
}
```

### Используемые библиотеки
- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) — логирование

### Как запустить
Используется встроенный в Python HTTP-сервер.
```bash
$ python -m http.server 8040
```
Сайт будет доступен по адресу [http://0.0.0.0:8040/](http://0.0.0.0:8040/).
Также можно просто открыть файл [`index.html`](index.html) в браузере.

## Бэкенд
Сервер, который связывает фронтенд и остальную инфраструктуру.
Для имитации нагрузки шлюзов, через которые связываются автобусы, используется отдельный скрипт.

### Загрузка маршрутов
Маршруты автобусов загружаются в директорию `/buses/routes/data` ([пример маршрута](buses/routes/data/28.json)).

### Как запустить
Запустите сервер
```bash
$ python -m buses.server
```

Поддерживаемые опции `-h`

| Аргумент          | Описание                           | По умолчанию |
|-------------------|------------------------------------|--------------|
| --host            | Адрес сервера                      | 127.0.0.1    |
| --bus_port        | Порт для автобусов (шлюзов)        | 8080         |
| --browser_port    | Порт для клиента (браузера)        | 8000         |
| --refresh_timeout | Интервал обновления автобусов      | 1            |
| -d, --debug       | Включить DEBUG уровень логирования | False        |

Запустите имитатор нагрузки, который сгенерирует автобусы и шлюзы
```bash
$ python -m buses.fake_bus
```

Поддерживаемые опции `-h`

| Аргумент            | Описание                                | По умолчанию |
|---------------------|-----------------------------------------|--------------|
| --host              | Адрес сервера                           | 127.0.0.1    |
| --port              | Порт сервера                            | 8080         |
| --routes_number     | Количество маршрутов                    | 1            |
| --buses_per_route   | Количество автобусов на каждом маршруте | 1            |
| --websockets_number | Количество шлюзов                       | 1            |
| --emulator_id       | Префикс к id автобусов                  | ''           |
| --refresh_timeout   | Интервал обновления автобусов           | 1            |
| -d, --debug         | Включить DEBUG уровень логирования      | False        |

### Используемые библиотеки
- [Trio](https://trio.readthedocs.io/en/stable/) — асинхронный фреймворк
- [pytest](https://docs.pytest.org/en/7.2.x/) — тестирование
- [jsons](https://jsons.readthedocs.io/en/latest/) — сериализация объектов

### Тестирование
```bash
$ pytest tests
```
